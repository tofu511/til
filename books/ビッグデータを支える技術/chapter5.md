# ビッグデータのパイプライン
## ワークフロー管理
- 企業内の定型的な業務プロセス(申請、承認、報告など)のような、決まった仕事を円滑に進めるための仕組みを一般にワークフロー管理(workflow management)と呼ぶ
- ワークフロー管理ツールの主な役割
  - 定期的にタスクを実行する
  - 異常を検知してその解決を手助けする

### ワークフロー管理ツールとタスク
- データパイプラインの実行過程では、データを次から次へと移動しながら決まった処理を繰り返す。このとき実行される個々の処理をタスクと呼ぶ

### 基本機能とビッグデータで求められる機能
- ワークフロー管理ツールは主として以下のような機能を提供する
  - タスクを定期的なスケジュールで実行し、その結果を通知する
  - タスク間の依存関係を定めて、決められた順にもれなく実行する
  - タスクの実行結果を保持し、エラー発生時には再実行できるようにする

## エラーからリカバリー方法を先に考える
### リカバリーとフローの再実行
- エラーには無数の可能性があるので、ワークフロー管理では基本的にエラーから自動回復できるものとは考えない
- 代わりに手作業によるリカバリーを前提としてタスクを設計する
  - 失敗したタスクは全て記録して、それを後から再実行できるようにする

## 冪等な操作としてタスクを記述する
- リカバリーの前提として再実行の安全性を忘れてはいけない
- 各タスクの原則は「最後まで成功」もしくは「失敗して何も残らない」のどちらか

### 冪等な操作
- より確実なのは「同じタスクを何度実行しても同じ結果になる」こと

### アトミックな追記
- 複雑なフローで1つのテーブルになんどもデータを書き込みたいときは、中間テーブル作成してから最後に目的にテーブルに追記するのが安全

### タスクキュー
- 大量のタスクを同時実行するとサーバーが過負荷になるので、ジョブキューやタスクキューを用いて負荷をコントロールする

## バッチ型のデータフロー
### MapReduceに代わる新しいフレームワーク
- 新しいフレームワークに共通するのがDAG(directed acylic graph)と呼ばれるデータ構造。日本語では有向非循環グラフと呼ばれる
- DAGは以下の性質をもつ
  - ノードとノードが矢印で結ばれる
  - 矢印をいくら辿っても同じノードに戻らない(非循環)
- MapReduceでは1つのノードで処理が終わらなければ次の処理に進めなかったが、データフローではDAGを構成する各ノードが全て同時並行で実行される
- DAGによるプログラミングの特徴は遅延評価

## ストリーミング型のデータフロー
### ストリーム処理とバッチ処理とを統合する
- バッチのようにデータ量が決まるものを有限データ(bounded data), ストリーム処理のように際限なくデータが送られてくるものを無限データ(unbounded data)と呼ぶ
　- データを小さく分割してDAGで実行する点は変わらない

### ストリーム処理の結果をバッチ処理で置き換える
- ストリーム処理には潜在的な問題が二つある
  - 基本的に一度処理すると時間を巻き戻せないので、間違った結果を修正できない
  - メッセージ配送が遅れることがあるので、イベント時間で厳密に集計できない
- 上記の問題の伝統的な対処方法はストリーム処理とは別でバッチ処理を走らせて、後者の結果を正とする
  - 定期的なレポートなどでよく使われる

#### ラムダアーキテクチャ
- 上記のストリーム処理とバッチ処理を組み合わせた方法の発展版としてラムダアーキテクチャがある
  - [Big Data + Fast Data = ラムダアーキテクチャー！](http://www.intellilink.co.jp/article/column/bigdata-kk03.html)
- ラムダアーキテクチャを単純化したカッパアーキテクチャというものもある
  - [ストリーム処理を１からKappa Architectreまで学ぶ](https://tech.plaid.co.jp/realtime_stream_system/)

### アウトオブオーダーなデータ処理
- ストリーム処理で正しい集計を行うときに問題になるのが遅れてくるメッセージ、つまりプロセス時間とイベント時間との差異
  - これは技術的にはアウトオブオーダーなデータ処理と呼ばれる

#### イベント時間ウィンドウイング
- ストリーム処理ではしばしば時間を一定間隔に区切ってウィンドウ(window)を作り、その中でデータの集計を行う
- イベント時間でウィンドウを分けることをイベント時間ウィンドウイング(event-time windowing)という


